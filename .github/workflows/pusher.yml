name: Keep Repo Active & Clean Workflows

on:
  schedule:
    - cron: '0 0 * * *'  # daily at midnight UTC
  workflow_dispatch:      # allows manual triggering

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo using PAT
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.DELETE_RUN_PAT }}

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create a no-op commit
        run: |
          echo "Keepalive $(date)" >> keepalive.txt
          git add keepalive.txt
          git commit -m "Keepalive commit $(date)" || echo "No changes to commit"

      - name: Push changes
        run: git push origin HEAD

      - name: Clean up old workflow runs
        env:
          GH_TOKEN: ${{ secrets.DELETE_RUN_PAT }}
        run: |
          # Get total number of workflow runs
          total_runs=$(gh api repos/${{ github.repository }}/actions/runs --jq '.total_count')
          echo "Total workflow runs: $total_runs"
          
          # If we have more than 50 runs, delete the old ones
          if [ $total_runs -gt 50 ]; then
            echo "Cleaning up old workflow runs, keeping only 50 most recent..."
            
            # Get all run IDs except the 50 most recent
            gh api repos/${{ github.repository }}/actions/runs --paginate \
              --jq '.workflow_runs[].id' | \
              tail -n +51 | \
              while read run_id; do
                echo "Deleting run ID: $run_id"
                gh api -X DELETE repos/${{ github.repository }}/actions/runs/$run_id
                sleep 0.5  # Small delay to avoid rate limits
              done
          else
            echo "Less than 50 workflow runs, no cleanup needed."
          fi
